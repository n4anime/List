<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>قائمة الأنمي - 03</title>

  <!-- خطوط وأيقونات -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- مكتبات مساعدة -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
  
  
  .count {
    background: #0000001c;
    color: #676767;
    padding: 0px 0px;
    border-radius: 50%;
    font-size: 11px;
    display: inline-flex;
    min-width: 15px;
    min-height: 15px;
    align-items: center;
    justify-content: center;
  }

  * {
    font-family: 'Baloo Bhaijaan 2', sans-serif;
  }

  .fa, .fas, .far, .fal, .fab {
    font-family: "Font Awesome 6 Free" !important;
  }

  body {
    margin: 0;
    padding: 0;
    font-family: 'Baloo Bhaijaan 2', cursive;
    background-color: #f2f2f2;
    direction: rtl;
  }
  h1 {
    text-align: center;
    margin: 20px 0;
    font-size: 24px;
    color: #333;
    font-weight: bold;
  }
  #favoritesToggle {
    display: block;
    margin: 6px auto;
    padding: 5px 16px;
    background: #0088cc;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  }
  #progressContainer {
    width: 80%;
    height: 20px;
    background: #ddd;
    border-radius: 10px;
    margin: 20px auto;
    overflow: hidden;
  }
  #progressBar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #0088cc, #00aaff);
  }
  #loader {
    text-align: center;
    margin-top: 20px;
    font-size: 14px;
    color: #0088cc;
  }

  #searchBox:hover {
    transform: translate(-2px, -2px) !important;
    box-shadow: 4px 4px 0 #000 !important;
  }

  #search-container {
    text-align: center;
    margin: 5px 0;
  }

  #searchBox {
    padding: 5px;
    width: 80%;
    max-width: 300px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  .cards-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    padding: 2px;
  }
  .card-wrapper {
    width: 250px;
    margin: 5px;
    position: relative;
  }
  .anime-card {
    width: 250px;
    min-height: 350px;
    height: 350px;
    position: relative;
    color: #fff;
    overflow: hidden;
    box-shadow: 0px 30px 0px 0px rgb(0 0 0);
    background-color: #000;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    margin-bottom: 0px;
  }
  .card-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    background-size: cover;
    background-position: center;
  }
  .overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1;
    backface-visibility: hidden;
  }
  .shadow-top {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 40%;
    background: linear-gradient(to bottom, rgb(0 0 0), transparent);
    z-index: 2;
  }
  .shadow-bottom {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 40%;
    background: linear-gradient(to top, rgb(0 0 0), transparent);
    z-index: 2;
  }
  .card-header-logo,
  .card-footer-logo,
  .card-top-bar,
  .card-content,
  .bottom-info,
  .story-box,
  .card-buttons {
    position: relative;
    z-index: 3;
  }
  .card-header-logo, .card-footer-logo {
    text-align: center;
    padding: 4px 1px;
  }
  .card-header-logo img,
  .card-footer-logo img {
    max-width: 35%;
    padding: 2px 1px;
    height: auto;
  }
  .card-top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2px 4px;
  }
  .anime-title {
    background: rgba(0,0,0,0.4);
    padding: 2px 4px;
    border-radius: 5px;
    font-size: 13.1px;
    flex: 1;
    margin: 0 4px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: bold;
  }
  .rating-area {
    display: flex;
    align-items: center;
    background: rgb(0 128 255 / 38%);
    padding: 2px 4px;
    border-radius: 5px;
    font-size: 13.1px;
    gap: 4px;
    font-weight: 200;
  }
  .rating-area img {
    width: 25px;
  }
  .card-content {
    display: flex;
    flex-direction: row;
    padding: 3px;
    gap: 2px;
    font-size: 13.1px;
  }
  .poster-div {
    width: 56px;
    height: 83px;
    border-radius: 5px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .poster-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: 5px;
  }
  .info-boxes {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .info-row {
    display: flex;
    gap: 2px;
  }
  .info-column {
    display: flex;
    flex-direction: column;
    gap: 2px;
    width: 100%;
  }
  .info-box {
    background: rgba(0,0,0,0.4);
    padding: 2px 4px;
    border-radius: 5px;
    font-size: 13.1px;
    line-height: 1.2;
    flex: 1;
    text-align: center;
  }
  .info-box strong,
  .info-box-genre strong {
    margin-left: 2px;
    font-weight: bold;
    color: #fffae0;
    font-size: 8px;
  }
  .info-box span {
    font-size: 12px;
  }
  .bottom-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin: 0 2px;
    font-size: 13.1px;
  }
  .bottom-row {
    display: flex;
    gap: 2px;
  }
  .info-box-genre {
    background: rgba(0,0,0,0.4);
    padding: 2px 4px;
    border-radius: 5px;
    font-size: 13.1px;
    line-height: 1.2;
    flex: 1;
    text-align: center;
  }
  .story-box {
    background: rgba(0,0,0,0.5);
    margin: 2px;
    padding: 1px;
    border-radius: 5px;
    font-size: 13.1px;
    line-height: 1.3;
  }
  .card-buttons {
    display: flex;
    justify-content: space-around;
    margin-bottom: 4px;
  }
  .card-buttons button {
    background-color: #FFFFFF;
    border: 1px solid #000;
    color: #111;
    padding: 3px 4px;
    border-radius: 0.0px;
    font-size: 11px;
    cursor: pointer;
    font-weight: 400;
    box-shadow: 2px 2px 0 #000;
  }
  .favorite-btn.active {
    background: gold;
    color: #000;
  }
  .card-buttons .share-btn.active-share {
    background-color: #cce9ff;
    color: #000;
  }
  .card-buttons .download-btn.active-download {
    background-color: #d5ffd5;
    color: #000;
  }
  #data-container {
    text-align: center;
    margin-top: 15px;
    color: #333;
    font-size: 18px;
    display: none;
  }

  .dropdown-check-list {
    display: inline-flex;
    margin: 3px;
    position: relative;
    flex-wrap: wrap;
    align-content: center;
    justify-content: center;
    align-items: center;
    width: 170px;
    box-sizing: border-box;
  }

  .dropdown-check-list .anchor {
    position: relative;
    cursor: pointer;
    display: inline-block;
    padding: 10px 30px 10px 15px;
    border: 1px solid #ccc;
    width: 100%;
    box-sizing: border-box;
    text-align: center;
  }
  .dropdown-check-list .anchor:after {
    position: absolute;
    content: "";
    border-left: 2px solid black;
    border-top: 2px solid black;
    padding: 5px;
    right: 10px;
    top: 20%;
    transform: rotate(-135deg);
  }
  .dropdown-check-list .anchor:active:after {
    right: 8px;
    top: 21%;
  }

  .dropdown-check-list ul.items {
    padding: 1px 1px 1px 0px;
    display: none;
    margin: 0;
    border: 1px solid #ccc;
    border-top: none;
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    z-index: 999;
    background: #fff;
    max-height: 400px;
    overflow-y: auto;
  }

  .dropdown-check-list ul.items li {
    list-style: none;
    padding: 6px;
  }
  .dropdown-check-list ul.items li label {
    cursor: pointer;
    display: block;
    padding: 4px;
  }
  .dropdown-check-list ul.items li label:hover {
    background-color: rgba(0,0,0,0.1);
  }
  .dropdown-check-list ul.items li label input:checked + .option-text {
    background-color: rgba(0,0,0,0.1);
  }
  .dropdown-check-list.visible .items {
    display: block;
  }

  @media (max-width: 600px) {
    .dropdown-check-list {
      width: 45%;
      box-sizing: border-box;
    }
    .dropdown-check-list .anchor {
      width: 90%;
    }
  }

  @media (max-width: 1000px) {
    .dropdown-check-list {
      width: 45%;
      box-sizing: border-box;
    }
    .dropdown-check-list .anchor {
      width: 90%;
    }
  }

  #list-Episode .anchor {
    background-color: #d0eaff;
    color: #007acc;
  }
  #list-Episode .anchor:hover {
    background-color: rgba(0,122,204,0.2);
  }
  #list-Episode.visible .anchor {
    background-color: #007acc;
    color: #fff;
  }
  #list-Source .anchor {
    background-color: #d0f5d0;
    color: #2e8b57;
  }
  #list-Source .anchor:hover {
    background-color: rgba(46,139,87,0.2);
  }
  #list-Source.visible .anchor {
    background-color: #2e8b57;
    color: #fff;
  }
  #list-Studio .anchor {
    background-color: #ffe5cc;
    color: #ff8c00;
  }
  #list-Studio .anchor:hover {
    background-color: rgba(255,140,0,0.2);
  }
  #list-Studio.visible .anchor {
    background-color: #ff8c00;
    color: #fff;
  }
  #list-Aired .anchor {
    background-color: #e6d0ff;
    color: #800080;
  }
  #list-Aired .anchor:hover {
    background-color: rgba(128,0,128,0.2);
  }
  #list-Aired.visible .anchor {
    background-color: #800080;
    color: #fff;
  }

  /* فلاتر التصنيفات والثيم */
  #list-Genre .anchor {
    background-color: #ffd0e8;
    color: #c2185b;
  }
  #list-Genre .anchor:hover {
    background-color: rgba(194,24,91,0.2);
  }
  #list-Genre.visible .anchor {
    background-color: #c2185b;
    color: #fff;
  }

  #list-Theme .anchor {
    background-color: #d0fff8;
    color: #00897b;
  }
  #list-Theme .anchor:hover {
    background-color: rgba(0,137,123,0.2);
  }
  #list-Theme.visible .anchor {
    background-color: #00897b;
    color: #fff;
  }

  /* ===== Neo-Brutalism Shell ===== */
  body {
    background-color: #FFE666;
  }

  #top-bar {
    background-color: #9bbbb2;
    border-radius: 0.0px;
    border: 1px solid #000;
    box-shadow: 2px 2px 0 #000;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    flex-wrap: wrap;
    margin: 15px 10px 5px;
  }
  #logo-box {
    flex: 0 0 auto;
  }
  #site-logo {
    max-height: 70px;
    width: auto;
    display: block;
  }
  #top-controls {
    display: flex;
    align-items: center;
    gap: 5px;
    flex-wrap: wrap;
    justify-content: center;
  }

  #filter-settings {
    text-align: center;
    margin-bottom: 4px;
  }
  #favoritesToggle {
    background-color: #FFEE58;
    color: #111;
    border-radius: 0.0px;
    border: 1px solid #000;
    box-shadow: 2px 2px 0 #000;
    margin: 0;
  }
  #favoritesToggle:hover {
    transform: translate(-2px, -2px);
    box-shadow: 4px 4px 0 #000;
  }
  #searchBox {
    box-shadow: 2px 2px 0 #000;
    background-color: #FFF7D1;
    border-radius: 0.0px;
    border: 1px solid #000;
    padding: 6px 5px;
    font-size: 14px;
    width: 150px;
    max-width: 70vw;
  }
  .cards-container {
    max-width: 1200px;
    margin: 0 auto 40px;
  }
  .dropdown-check-list .anchor {
    background-color: #FFF7D1;
    border-radius: 0.0px;
    border: 1px solid #000;
    box-shadow: 2px 2px 0 #000;
  }
  .dropdown-check-list.visible .anchor {
    transform: translate(-2px, -2px);
    box-shadow: 4px 4px 0 #000;
  }
  .dropdown-check-list ul.items {
    border-radius: 0.0px;
    border: 1px solid #000;
    box-shadow: 2px 2px 0 #000;
  }
  #progressContainer {
    border-radius: 16px;
    border: 3px solid #000;
    background-color: #FFF;
  }
  #progressBar {
    background: #FFB74D;
  }
  #loader {
    color: #111;
    font-weight: 600;
  }

  .dropdown-check-list ul.items li {
    padding: 3px 3px;
  }
  .dropdown-check-list ul.items li label {
    background-color: #FFFFFF;
    border-radius: 0.0px;
    border: 1px solid #000;
    padding: 2px 5px;
    display: flex;
    align-items: center;
    gap: 2px;
    box-shadow: 2px 2px 0 #000;
    line-height: 1.5;
    word-wrap: break-word;
  }
  .dropdown-check-list ul.items li label:hover {
    background-color: #FFF0B3;
  }
  .dropdown-check-list ul.items li input[type="checkbox"] {
    width: 14px;
    height: 14px;
  }
  .dropdown-check-list ul.items li label .option-text {
    background: transparent;
    padding: 0;
  }
  .dropdown-check-list ul.items li label input:checked + .option-text {
    background-color: transparent;
    font-weight: 700;
  }

  .dropdown-check-list .anchor,
  .dropdown-check-list ul.items li label {
    transition: transform 0s ease-out, box-shadow 0s ease-out;
  }
  .dropdown-check-list .anchor:hover,
  .dropdown-check-list ul.items li label:hover {
    transform: translate(-2px, -2px);
    box-shadow: 4px 4px 0 #000;
  }

  button:hover, .btn:hover {
    transform: translate(-2px, -2px) !important;
    box-shadow: 4px 4px 0 #000 !important;
  }

  #pagination {
    text-align: center;
    margin: 10px 0;
  }
  #pagination button {
    margin: 5px;
    padding: 3px 11px;
    border-radius: 0;
    border: 1px solid #000;
    cursor: pointer;
    background-color: #FFF7D1;
    box-shadow: 2px 2px 0 #000;
    font-family: 'Baloo Bhaijaan 2', cursive;
  }
  #pagination button.active-page {
    background-color: #0088cc;
    color: #fff;
    font-weight: bold;
  }
  #pagination button:hover {
    transform: translate(-2px, -2px);
    box-shadow: 4px 4px 0 #000;
  }

  #backToTop {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 40px;
    height: 40px;
    border-radius: 999px;
    border: 1px solid #000;
    background-color: #FFF7D1;
    box-shadow: 2px 2px 0 #000;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 999;
  }
  #backToTop i {
    pointer-events: none;
  }
  #backToTop:hover {
    transform: translate(-2px, -2px);
    box-shadow: 4px 4px 0 #000;
  }

  </style>
</head>
<body>
  <header>
    <div id="top-bar">
      <img id="site-logo" src="https://i.suar.me/OzJaa/l" alt="شعار الموقع">
      <div id="top-controls">
        <input id="searchBox" type="text" placeholder="ابحث هنا..." />
        <button id="favoritesToggle" class="top-btn"><i class="fas fa-bookmark"></i> اظهار المفضلات (0)</button>
        <button id="loginSyncBtn" class="top-btn"><i class="fa-brands fa-google"></i> سجل لحفظ مفضلتك</button>
        <button id="topLikesFilterBtn" class="top-btn"><i class="fa-solid fa-fire"></i> أفضل اللايكات</button>
      </div>
    </div>

    <div id="filter-settings">
      <div id="list-Episode" class="dropdown-check-list" tabindex="100">
        <span class="anchor"><i class="fa-solid fa-list-ol"></i> فلتر الحلقات</span>
        <ul class="items"></ul>
      </div>
      <div id="list-Source" class="dropdown-check-list" tabindex="100">
        <span class="anchor"><i class="fa-solid fa-book-open"></i> فلتر الاقتباس</span>
        <ul class="items"></ul>
      </div>
      <div id="list-Studio" class="dropdown-check-list" tabindex="100">
        <span class="anchor"><i class="fa-solid fa-clapperboard"></i> فلتر الاستوديو</span>
        <ul class="items"></ul>
      </div>
      <div id="list-Aired" class="dropdown-check-list" tabindex="100">
        <span class="anchor"><i class="fa-solid fa-calendar-days"></i> تاريخ العرض</span>
        <ul class="items"></ul>
      </div>
      <div id="list-Genre" class="dropdown-check-list" tabindex="100">
        <span class="anchor"><i class="fa-solid fa-tags"></i> تصنيفات</span>
        <ul class="items"></ul>
      </div>
      <div id="list-Theme" class="dropdown-check-list" tabindex="100">
        <span class="anchor"><i class="fa-solid fa-mask"></i> ثيم</span>
        <ul class="items"></ul>
      </div>
    </div>

    <div id="pagination"></div>

    <div id="loader">
      <div id="progressContainer">
        <div id="progressBar"></div>
      </div>
      <div id="progressText">جارٍ تجهيز القائمة...</div>
    </div>
  </header>

  <div id="data-container"></div>
  <div id="pagination-bottom"></div>

  <button id="backToTop" title="أعلى الصفحة"><i class="fa-solid fa-arrow-up"></i></button>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBbYZ7Zk7Aoi7ePeSx2MM0t-T9vDFXtxxo",
      authDomain: "allanimefir.firebaseapp.com",
      projectId: "allanimefir",
      storageBucket: "allanimefir.firebasestorage.app",
      messagingSenderId: "45617829708",
      appId: "1:45617829708:web:12b65ad79e49531754a1e9"
    };
    firebase.initializeApp(firebaseConfig);

    let auth = firebase.auth();
    let db   = firebase.firestore();
    let favoritesCollection = db.collection("favorites");
    let likesCollection     = db.collection("likes");

    // بيانات الأنمي (مثال – زوّدها براحتك)
    const allAnimeData = [
      {
        Numb: "1",
        Cover: "https://cdn.myanimelist.net/images/anime/1520/147248l.jpg",
        Title: "Little Witch Academia (TV)",
        Rating: "7.8",
        Episode: "25",
        Aired: "2017",
        Source: "اصلي",
        Studio: "Trigger",
        Genre: "مغامرات, كوميديا, فانتازيا",
        Theme: "مدرسي",
        Story: "أكّو كاغاري فتاة عادية تحلم بأن تصبح ساحرة مثل بطلتها شايني شاريـوت. تلتحق بأكاديمية لونا نوفا رغم ضعفها في السحر، ترافقها لوتّي وسوسي، وتجد عصا شاريـوت لتبدأ مغامراتها في عالم يتراجع فيه السحر."
      },
      {
        Numb: "2",
        Cover: "https://cdn.myanimelist.net/images/anime/11/54319l.jpg",
        Title: "Samurai Flamenco",
        Rating: "6.88",
        Episode: "22",
        Aired: "2013",
        Source: "اصلي",
        Studio: "Manglobe",
        Genre: "أكشن, كوميديا",
        Theme: "بالغين, محاكاة ساخرة, قوة خارقة",
        Story: "ماسايوشي هازاما عارض أزياء يعيش حلم الأبطال الخارقين باسم يناضل ضد المخالفات البسيطة حتى الجرائم الكبرى، ينكشف سره أمام الشرطي غوتو، وتتصاعد الأحداث لتطال مصير العالم كله."
      }
    ];

    // متغيرات عامة
    const LOCAL_FAV_KEY   = "animeFavorites";
    const LOCAL_LIKES_KEY = "animeLikesLocal";
    const LOCAL_GUEST_ID  = "animeGuestId";

    let favorites   = new Set();
    let localLikes  = null;  // {cardId:true}
    let sharedCards = new Set();
    let downloadedCards = new Set();

    let currentUser = null;

    let activeFilters = {
      Episode: [],
      Source: [],
      Studio: [],
      Aired:  [],
      Genre:  [],
      Theme:  []
    };

    const pageSize = 50;
    let currentPage     = 1;
    let showFavOnly     = false;
    let topLikesMode    = false;
    let topLikesList    = [];

    // helpers
    function getGuestId(){
      let id = localStorage.getItem(LOCAL_GUEST_ID);
      if(!id){
        id = "g_" + Math.random().toString(36).slice(2);
        localStorage.setItem(LOCAL_GUEST_ID,id);
      }
      return id;
    }

    function loadLocalLikes(){
      if(localLikes !== null) return;
      try{
        const s = localStorage.getItem(LOCAL_LIKES_KEY);
        localLikes = s ? JSON.parse(s) : {};
      }catch(e){localLikes = {};}
    }
    function saveLocalLikes(){
      try{ localStorage.setItem(LOCAL_LIKES_KEY, JSON.stringify(localLikes || {})); }
      catch(e){}
    }
    function loadFavoritesLocal(){
      try{
        const s = localStorage.getItem(LOCAL_FAV_KEY);
        favorites = s ? new Set(JSON.parse(s)) : new Set();
      }catch(e){favorites = new Set();}
    }
    function saveFavoritesLocal(){
      try{
        localStorage.setItem(LOCAL_FAV_KEY, JSON.stringify(Array.from(favorites)));
      }catch(e){}
    }
    function saveFavoritesToServer(){
      if(!currentUser) return;
      favoritesCollection
        .doc(currentUser.uid)
        .set({items: Array.from(favorites)}, {merge:true})
        .catch(console.error);
    }
    function mergeFavoritesWithServer(){
      if(!currentUser){loadFavoritesLocal();updateFavoritesCount();renderCardsWithFilters(showFavOnly);return;}
      let localArr = [];
      try{
        const s = localStorage.getItem(LOCAL_FAV_KEY);
        localArr = s ? JSON.parse(s) : [];
      }catch(e){localArr = [];}
      favoritesCollection.doc(currentUser.uid).get().then(doc=>{
        const union = new Set(localArr);
        if(doc.exists && Array.isArray(doc.data().items)){
          doc.data().items.forEach(id=>union.add(id));
        }
        favorites = union;
        saveFavoritesLocal();
        saveFavoritesToServer();
        updateFavoritesCount();
        renderCardsWithFilters(showFavOnly);
      }).catch(err=>{
        console.error(err);
        loadFavoritesLocal();
        updateFavoritesCount();
        renderCardsWithFilters(showFavOnly);
      });
    }

    function updateFavoritesCount(){
      const btn = document.getElementById("favoritesToggle");
      if(!btn) return;
      const label = showFavOnly ? "اظهار الكل" : "اظهار المفضلات";
      btn.innerHTML = '<i class="fas fa-bookmark"></i> ' + label + " ("+favorites.size+")";
    }

    function isShowingFavoritesOnly(){return showFavOnly;}

    // بحث
    function matchesSearch(anime,q){
      if(!q) return true;
      q = q.toLowerCase();
      for(let k in anime){
        if(anime[k] && anime[k].toString().toLowerCase().includes(q)) return true;
      }
      return false;
    }
    function getUniqueId(anime,index){
      return "wrapper-"+(anime.Numb || (index+1));
    }

    function getFilteredAnime(showFav){
      const searchInput = document.getElementById("searchBox");
      const q = searchInput ? searchInput.value.trim().toLowerCase() : "";
      const result = [];
      allAnimeData.forEach((anime,idx)=>{
        const uid = getUniqueId(anime,idx);
        if(showFav && !favorites.has(uid)) return;
        if(!matchesSearch(anime,q)) return;

        // فلاتر
        let pass = true;
        for(let key in activeFilters){
          const selected = activeFilters[key];
          if(!selected || selected.length===0) continue;
          let vals = [];
          if(key==="Genre"||key==="Theme"){
            vals = (anime[key]||"").split(",").map(v=>v.trim()).filter(Boolean);
          }else{
            vals = [anime[key]||"-"];
          }
          const ok = vals.some(v=>selected.includes(v));
          if(!ok){pass=false;break;}
        }
        if(!pass) return;
        result.push({anime,uniqueId:uid});
      });

      if (topLikesMode && topLikesList.length > 0) {
        const onlyLiked = result.filter(item => topLikesList.includes(item.uniqueId));
        onlyLiked.sort((a, b) => {
          const ia = topLikesList.indexOf(a.uniqueId);
          const ib = topLikesList.indexOf(b.uniqueId);
          return ia - ib;
        });
        return onlyLiked;
      }
      return result;
    }

    // فلاتر
    function populateCustomDropdown(filterType){
      const container = document.getElementById("list-"+filterType);
      if(!container) return;
      const ul = container.querySelector(".items");
      if(!ul) return;
      ul.innerHTML = "";

      const liAll = document.createElement("li");
      const chkAll = document.createElement("input");
      chkAll.type = "checkbox";
      chkAll.value = "all";
      chkAll.checked = activeFilters[filterType].length===0;
      chkAll.addEventListener("change",function(){
        if(this.checked){
          activeFilters[filterType]=[];
          ul.querySelectorAll('input[type="checkbox"]').forEach(c=>{if(c.value!=="all") c.checked=false;});
          currentPage=1;renderCardsWithFilters(showFavOnly);
        }
      });
      const lblAll = document.createElement("label");
      lblAll.appendChild(chkAll);
      const spanAll = document.createElement("span");
      spanAll.textContent = " اظهار الكل";
      lblAll.appendChild(spanAll);
      liAll.appendChild(lblAll);
      ul.appendChild(liAll);

      let distinct = [];
      let counts = {};

      allAnimeData.forEach((anime,idx)=>{
        const uid = getUniqueId(anime,idx);
        if(showFavOnly && !favorites.has(uid)) return;

        if(filterType==="Genre" || filterType==="Theme"){
          const raw = anime[filterType]||"";
          const arr = raw.split(",").map(v=>v.trim()).filter(Boolean);
          [...new Set(arr)].forEach(v=>{
            if(!distinct.includes(v)) distinct.push(v);
            counts[v]=(counts[v]||0)+1;
          });
        }else{
          const v = anime[filterType]||"-";
          if(!distinct.includes(v)) distinct.push(v);
          counts[v]=(counts[v]||0)+1;
        }
      });

      if(filterType==="Episode"||filterType==="Aired"){
        distinct.sort((a,b)=>{
          const na=parseFloat(a), nb=parseFloat(b);
          if(!isNaN(na)&&!isNaN(nb)) return nb-na;
          return a.toString().localeCompare(b.toString(),"ar");
        });
      }else{
        distinct.sort((a,b)=>a.toString().localeCompare(b.toString(),"ar"));
      }

      distinct.forEach(val=>{
        const li = document.createElement("li");
        const chk = document.createElement("input");
        chk.type="checkbox";
        chk.value=val;
        if(activeFilters[filterType].includes(val)) chk.checked=true;
        chk.addEventListener("change",function(){
          const allChk = ul.querySelector('input[value="all"]');
          if(this.checked && allChk) allChk.checked = false;
          updateActiveFilter(filterType,ul);
        });
        const lbl = document.createElement("label");
        lbl.appendChild(chk);
        const span = document.createElement("span");
        span.innerHTML = " "+val+' <span class="count">'+(counts[val]||0)+'</span>';
        lbl.appendChild(span);
        li.appendChild(lbl);
        ul.appendChild(li);
      });
    }

    function updateActiveFilter(filterType,ul){
      const checked = [];
      ul.querySelectorAll('input[type="checkbox"]').forEach(c=>{
        if(c.value!=="all" && c.checked) checked.push(c.value);
      });
      activeFilters[filterType]=checked;
      if(checked.length===0){
        const allChk = ul.querySelector('input[value="all"]');
        if(allChk) allChk.checked=true;
      }
      currentPage=1;
      renderCardsWithFilters(showFavOnly);
    }

    function setupCustomDropdown(filterType){
      const container = document.getElementById("list-"+filterType);
      if(!container) return;
      const anchor = container.querySelector(".anchor");
      if(!anchor) return;
      anchor.onclick = function(){
        document.querySelectorAll(".dropdown-check-list").forEach(d=>{
          if(d!==container) d.classList.remove("visible");
        });
        container.classList.toggle("visible");
      };
    }

    // لايكات
    function setupLikeState(uniqueId,likeButton){
      const likeIcon  = likeButton.querySelector(".like-icon");
      const likeCountSpan = likeButton.querySelector(".like-count");
      loadLocalLikes();
      let baseCount = 0;
      let userHasLiked = false;

      if(!likesCollection){
        const localFlag = !!localLikes[uniqueId];
        userHasLiked = localFlag;
        baseCount = localFlag ? 1 : 0;
        likeCountSpan.textContent = baseCount;
        if(userHasLiked) likeIcon.style.color="red";

        likeButton.addEventListener("click",()=>{
          userHasLiked = !userHasLiked;
          if(userHasLiked){
            localLikes[uniqueId]=true;
            baseCount=1;
            likeIcon.style.color="red";
          }else{
            delete localLikes[uniqueId];
            baseCount=0;
            likeIcon.style.color="#000";
          }
          likeCountSpan.textContent = baseCount;
          saveLocalLikes();
        });
        return;
      }

      const guestId = getGuestId();
      const likeDocRef = likesCollection.doc(uniqueId);

      likeDocRef.get().then(doc=>{
        let data = doc.exists ? (doc.data()||{}) : {};
        let count = typeof data.count==="number" ? data.count : 0;
        const users  = data.users  || {};
        const guests = data.guests || {};

        if(currentUser && users[currentUser.uid]){
          userHasLiked = true;
        }else if(!currentUser && guests[guestId]){
          userHasLiked = true;
        }else if(!currentUser && localLikes[uniqueId]){
          // لايك قديم محلي فقط، لا نزيد العداد لكن نلوّن الزر
          userHasLiked = true;
        }
        baseCount = count;
        if(userHasLiked) likeIcon.style.color="red";
        likeCountSpan.textContent = baseCount;
        likeButton.dataset.userHasLiked = userHasLiked ? "1":"0";
      }).catch(()=>{
        const localFlag = !!localLikes[uniqueId];
        userHasLiked = localFlag;
        baseCount = localFlag ? 1:0;
        likeCountSpan.textContent = baseCount;
        if(userHasLiked) likeIcon.style.color="red";
        likeButton.dataset.userHasLiked = userHasLiked ? "1":"0";
      });

      likeButton.addEventListener("click",()=>{
        loadLocalLikes();
        const already = likeButton.dataset.userHasLiked==="1";

        likesCollection.doc(uniqueId).get().then(doc=>{
          let data = doc.exists ? (doc.data()||{}) : {};
          let count = typeof data.count==="number" ? data.count : 0;
          const users  = data.users  || {};
          const guests = data.guests || {};

          if(currentUser){
            if(already && users[currentUser.uid]){
              delete users[currentUser.uid];
              count = Math.max(0,count-1);
              likeIcon.style.color="#000";
              likeButton.dataset.userHasLiked="0";
            }else if(!already && !users[currentUser.uid]){
              users[currentUser.uid]=true;
              count = count+1;
              likeIcon.style.color="red";
              likeButton.dataset.userHasLiked="1";
            }
          }else{
            if(already && (guests[guestId] || localLikes[uniqueId])){
              delete guests[guestId];
              delete localLikes[uniqueId];
              count = Math.max(0,count-1);
              likeIcon.style.color="#000";
              likeButton.dataset.userHasLiked="0";
            }else if(!already){
              guests[guestId]=true;
              localLikes[uniqueId]=true;
              count = count+1;
              likeIcon.style.color="red";
              likeButton.dataset.userHasLiked="1";
            }
          }

          likeCountSpan.textContent = count;
          localLikes[uniqueId] = likeButton.dataset.userHasLiked==="1";
          saveLocalLikes();

          likesCollection.doc(uniqueId).set({
            count:count,
            users:users,
            guests:guests
          },{merge:true}).catch(console.error);
        }).catch(err=>{
          console.error(err);
        });
      });
    }

    function loadTopLikesList(callback){
      if(!likesCollection){
        loadLocalLikes();
        callback(Object.keys(localLikes||{}));
        return;
      }
      likesCollection.orderBy("count","desc").limit(50).get()
        .then(snap=>{
          const arr = [];
          snap.forEach(doc=>{
            if((doc.data()||{}).count>0) arr.push(doc.id);
          });
          if(arr.length===0){
            loadLocalLikes();
            callback(Object.keys(localLikes||{}));
          }else{
            callback(arr);
          }
        })
        .catch(err=>{
          console.error("loadTopLikesList",err);
          loadLocalLikes();
          callback(Object.keys(localLikes||{}));
        });
    }

    // بناء الكرت
    function createCardWrapper(uniqueId,anime,index){
      const wrapper = document.createElement("div");
      wrapper.className = "card-wrapper";
      wrapper.id = uniqueId;
      if(favorites.has(uniqueId)) wrapper.classList.add("favorite");

      const card = document.createElement("div");
      card.className = "anime-card";
      card.id = "card-"+uniqueId;

      const bg = document.createElement("div");
      bg.className="card-bg";
      bg.style.backgroundImage = "url("+(anime.Cover||"")+")";
      card.appendChild(bg);

      const overlay = document.createElement("div");
      overlay.className="overlay";
      card.appendChild(overlay);

      const shTop = document.createElement("div");
      shTop.className="shadow-top";
      card.appendChild(shTop);
      const shBot = document.createElement("div");
      shBot.className="shadow-bottom";
      card.appendChild(shBot);

      const headLogo = document.createElement("div");
      headLogo.className="card-header-logo";
      const headImg = document.createElement("img");
      headImg.src="https://i.suar.me/OzJaa/l";
      headImg.alt="Logo";
      headImg.crossOrigin="anonymous";
      headLogo.appendChild(headImg);
      card.appendChild(headLogo);

      const topBar = document.createElement("div");
      topBar.className="card-top-bar";
      const titleDiv = document.createElement("div");
      titleDiv.className="anime-title";
      titleDiv.textContent = anime.Title || "عنوان غير متوفر";
      const rateDiv = document.createElement("div");
      rateDiv.className="rating-area";
      const rateImg = document.createElement("img");
      rateImg.src="https://i.suar.me/8GKKn/l";
      rateImg.alt="MAL";
      rateImg.crossOrigin="anonymous";
      const rateText = document.createElement("span");
      rateText.textContent = anime.Rating ? anime.Rating : "-";
      rateDiv.appendChild(rateImg);
      rateDiv.appendChild(rateText);
      topBar.appendChild(titleDiv);
      topBar.appendChild(rateDiv);
      card.appendChild(topBar);

      const content = document.createElement("div");
      content.className="card-content";
      const posterDiv = document.createElement("div");
      posterDiv.className="poster-div";
      const posterImg = document.createElement("img");
      posterImg.className="poster-img";
      posterImg.src = anime.Cover||"";
      posterImg.alt="Poster";
      posterImg.crossOrigin="anonymous";
      posterDiv.appendChild(posterImg);
      content.appendChild(posterDiv);

      const infoDiv = document.createElement("div");
      infoDiv.className="info-boxes";

      const row1 = document.createElement("div");row1.className="info-row";
      const epBox = document.createElement("div");epBox.className="info-box";
      epBox.innerHTML = "<strong>حلقات:</strong> "+(anime.Episode||"-");
      const airBox = document.createElement("div");airBox.className="info-box";
      airBox.innerHTML = "<strong>تاريخ:</strong> "+(anime.Aired||"-");
      row1.appendChild(epBox);row1.appendChild(airBox);

      const row2 = document.createElement("div");row2.className="info-row";
      const srcBox = document.createElement("div");srcBox.className="info-box";
      srcBox.innerHTML = "<strong>اقتباس:</strong> "+(anime.Source||"-");
      const stdBox = document.createElement("div");stdBox.className="info-box";
      stdBox.innerHTML = "<strong>استديو:</strong> "+(anime.Studio||"-");
      row2.appendChild(srcBox);row2.appendChild(stdBox);

      const row3 = document.createElement("div");row3.className="info-row";
      const col = document.createElement("div");col.className="info-column";
      const genBox = document.createElement("div");genBox.className="info-box-genre";
      genBox.innerHTML = "<strong>تصنيف:</strong> "+(anime.Genre||"-");
      const thBox = document.createElement("div");thBox.className="info-box-genre";
      thBox.innerHTML = "<strong>ثيم:</strong> "+(anime.Theme||"-");
      col.appendChild(genBox);col.appendChild(thBox);
      row3.appendChild(col);

      infoDiv.appendChild(row1);
      infoDiv.appendChild(row2);
      infoDiv.appendChild(row3);
      content.appendChild(infoDiv);
      card.appendChild(content);

      const storyDiv = document.createElement("div");
      storyDiv.className="story-box";
      storyDiv.textContent = anime.Story||"";
      card.appendChild(storyDiv);

      const footLogo = document.createElement("div");
      footLogo.className="card-footer-logo";
      const footImg = document.createElement("img");
      footImg.src="https://i.suar.me/evdMd/l";
      footImg.alt="logo";
      footImg.crossOrigin="anonymous";
      footLogo.appendChild(footImg);
      card.appendChild(footLogo);

      if (topLikesMode) {
        const badge = document.createElement("div");
        badge.className = "top-like-rank";
        badge.textContent = (index + 1).toString();
        card.appendChild(badge);
      }

      const buttonsDiv = createCardButtons(uniqueId,card.id);
      wrapper.appendChild(card);
      wrapper.appendChild(buttonsDiv);
      return wrapper;
    }

    function createCardButtons(uniqueId,cardId){
      const buttonsDiv = document.createElement("div");
      buttonsDiv.className="card-buttons";

      const favBtn = document.createElement("button");
      favBtn.className="favorite-btn";
      favBtn.innerHTML = "<i class='fas fa-bookmark'></i> اضافة الى المفضلة";
      if(favorites.has(uniqueId)) favBtn.classList.add("active");
      favBtn.addEventListener("click",e=>{
        e.stopPropagation();
        toggleFavorite(uniqueId,favBtn);
      });

      const shareBtn = document.createElement("button");
      shareBtn.className="share-btn";
      shareBtn.innerHTML="<i class='fas fa-share-alt'></i> مشاركة";
      shareBtn.addEventListener("click",e=>{
        e.stopPropagation();
        shareCard(cardId,uniqueId,shareBtn);
      });

      const dlBtn = document.createElement("button");
      dlBtn.className="download-btn";
      dlBtn.innerHTML="<i class='fas fa-download'></i> تنزيل كصورة";
      dlBtn.addEventListener("click",e=>{
        e.stopPropagation();
        downloadCard(cardId,uniqueId,dlBtn);
      });

      const likeBtn = document.createElement("button");
      likeBtn.className="like-btn";
      likeBtn.innerHTML = "<i class='fa-solid fa-heart like-icon'></i> <span class='like-count'>0</span>";
      setupLikeState(uniqueId,likeBtn);

      buttonsDiv.appendChild(favBtn);
      buttonsDiv.appendChild(shareBtn);
      buttonsDiv.appendChild(dlBtn);
      buttonsDiv.appendChild(likeBtn);
      return buttonsDiv;
    }

    // مفضلة
    function toggleFavorite(uniqueId,btn){
      const wrap = document.getElementById(uniqueId);
      if(favorites.has(uniqueId)){
        favorites.delete(uniqueId);
        btn.classList.remove("active");
        if(wrap) wrap.classList.remove("favorite");
      }else{
        favorites.add(uniqueId);
        btn.classList.add("active");
        if(wrap) wrap.classList.add("favorite");
      }
      saveFavoritesLocal();
      if(currentUser) saveFavoritesToServer();
      updateFavoritesCount();
    }

    // مشاركة / تحميل
    function shareCard(cardId,uniqueId,btn){
      const card = document.getElementById(cardId);
      if(!card) return;
      const original = card.style.transform;
      card.style.transform="none";
      html2canvas(card,{useCORS:true,scale:3,imageSmoothingEnabled:false}).then(canvas=>{
        card.style.transform=original;
        canvas.toBlob(blob=>{
          if(navigator.share && navigator.canShare && navigator.canShare({files:[new File([blob],"anime-card.png",{type:"image/png"})]})){
            const file = new File([blob],"anime-card.png",{type:"image/png"});
            navigator.share({files:[file],title:"بطاقة أنمي"}).catch(()=>{});
          }else{
            const link = document.createElement("a");
            link.download="card.png";
            link.href=canvas.toDataURL();
            link.click();
          }
          btn.classList.add("active-share");
        });
      });
    }
    function downloadCard(cardId,uniqueId,btn){
      const card = document.getElementById(cardId);
      if(!card) return;
      const original = card.style.transform;
      card.style.transform="none";
      html2canvas(card,{useCORS:true,scale:3,imageSmoothingEnabled:false}).then(canvas=>{
        card.style.transform=original;
        const titleEl = card.querySelector(".anime-title");
        let name = "card";
        if(titleEl && titleEl.textContent) name = titleEl.textContent.trim().replace(/[\\/:*?"<>|]/g,"_");
        const link = document.createElement("a");
        link.download = name+".png";
        link.href = canvas.toDataURL();
        link.click();
        btn.classList.add("active-download");
      });
    }

    // عرض الكروت
    function renderPagination(totalItems){
      const top = document.getElementById("pagination");
      const bot = document.getElementById("pagination-bottom");
      if(top) top.innerHTML="";
      if(bot) bot.innerHTML="";
      const totalPages = Math.max(1,Math.ceil(totalItems/pageSize));
      if(totalPages<=1) return;

      function makeBtn(i){
        const b=document.createElement("button");
        b.textContent=i;
        if(i===currentPage) b.classList.add("active-page");
        b.addEventListener("click",()=>{
          currentPage=i;
          renderCardsWithFilters(showFavOnly);
          window.scrollTo({top:0,behavior:"smooth"});
        });
        return b;
      }
      for(let i=1;i<=totalPages;i++){
        const b1=makeBtn(i);
        const b2=makeBtn(i);
        top.appendChild(b1);
        bot.appendChild(b2);
      }
    }

    function renderCardsWithFilters(showFav){
      const containerOuter = document.getElementById("data-container");
      if(!containerOuter) return;
      const cardsDiv = document.createElement("div");
      cardsDiv.className="cards-container";

      const filtered = getFilteredAnime(showFav);
      const totalItems = filtered.length;
      const totalPages = Math.max(1,Math.ceil(totalItems/pageSize));
      if(currentPage>totalPages) currentPage=totalPages;

      const start = (currentPage-1)*pageSize;
      const end   = start+pageSize;
      const pageItems = filtered.slice(start,end);

      pageItems.forEach((item,idx)=>{
        const w = createCardWrapper(item.uniqueId,item.anime,idx);
        cardsDiv.appendChild(w);
      });

      containerOuter.innerHTML="";
      containerOuter.appendChild(cardsDiv);
      renderPagination(totalItems);

      // تحديث قيم الفلاتر بعد كل عرض
      ["Episode","Source","Studio","Aired","Genre","Theme"].forEach(populateCustomDropdown);
    }

    // توب لايكس
    function toggleTopLikesMode(){
      const btn = document.getElementById("topLikesFilterBtn");
      if(!btn) return;
      if(topLikesMode){
        topLikesMode=false;
        topLikesList=[];
        btn.classList.remove("active-toplikes");
        currentPage=1;
        renderCardsWithFilters(showFavOnly);
        return;
      }
      loadTopLikesList(list=>{
        topLikesList=list;
        topLikesMode=true;
        btn.classList.add("active-toplikes");
        currentPage=1;
        renderCardsWithFilters(showFavOnly);
      });
    }

    // تفعيل الصفحة
    document.addEventListener("DOMContentLoaded",function(){
      const favBtn   = document.getElementById("favoritesToggle");
      const searchEl = document.getElementById("searchBox");
      const topLikesBtn = document.getElementById("topLikesFilterBtn");
      const loginBtn = document.getElementById("loginSyncBtn");
      const loader   = document.getElementById("loader");
      const dataCont = document.getElementById("data-container");
      const progress = document.getElementById("progressBar");
      const backToTop = document.getElementById("backToTop");

      loadFavoritesLocal();
      loadLocalLikes();
      updateFavoritesCount();

      ["Episode","Source","Studio","Aired","Genre","Theme"].forEach(setupCustomDropdown);

      if(favBtn){
        favBtn.addEventListener("click",()=>{
          showFavOnly = !showFavOnly;
          updateFavoritesCount();
          currentPage=1;
          renderCardsWithFilters(showFavOnly);
        });
      }
      if(searchEl){
        searchEl.addEventListener("input",()=>{
          currentPage=1;
          renderCardsWithFilters(showFavOnly);
        });
      }
      if(topLikesBtn){
        topLikesBtn.addEventListener("click",toggleTopLikesMode);
      }

      window.addEventListener("scroll",()=>{
        if(window.scrollY>300) backToTop.style.display="flex";
        else backToTop.style.display="none";
      });
      backToTop.addEventListener("click",()=>{
        window.scrollTo({top:0,behavior:"smooth"});
      });

      // Auth
      if(loginBtn){
        if(location.protocol==="file:"){
          loginBtn.addEventListener("click",function(){
            alert("تسجيل الدخول بقوقل لا يعمل من ملف محلي، ارفع الصفحة على موقع http/https.");
          });
        }else{
          const provider = new firebase.auth.GoogleAuthProvider();
          auth.onAuthStateChanged(user=>{
            currentUser=user;
            if(user){
              loginBtn.innerHTML="تسجيل خروج <i class='fa-brands fa-google'></i>";
              mergeFavoritesWithServer();
            }else{
              loginBtn.innerHTML="<i class='fa-brands fa-google'></i> سجل لحفظ مفضلتك";
              loadFavoritesLocal();
              updateFavoritesCount();
              renderCardsWithFilters(showFavOnly);
            }
          });
          loginBtn.addEventListener("click",()=>{
            if(!currentUser){
              auth.signInWithPopup(provider).catch(err=>console.log("Auth error:",err));
            }else{
              auth.signOut().catch(err=>console.log("Signout error:",err));
            }
          });
        }
      }

      if(progress){
        progress.style.width="40%";
        setTimeout(()=>{progress.style.width="80%";},250);
        setTimeout(()=>{
          progress.style.width="100%";
          if(loader) loader.style.display="none";
          if(dataCont) dataCont.style.display="block";
          renderCardsWithFilters(false);
        },600);
      }else{
        if(loader) loader.style.display="none";
        if(dataCont) dataCont.style.display="block";
        renderCardsWithFilters(false);
      }
    });
  </script>
</body>
</html>
